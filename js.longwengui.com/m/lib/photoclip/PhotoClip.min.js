/* PhotoClip v3.0.8 | (c) 2014-2017 BaiJunjie | GPL Licensed | Relying on the plug-in [iscroll-zoom.js] [hammer.js] [lrz.all.bundle.js] */
!function(t,i){"use strict";"object"==typeof module&&"object"==typeof exports?module.exports=i(require("./iscroll-zoom"),require("./hammer.min"),require("./lrz.all.bundle")):"function"==typeof define&&define.amd?define(["iscroll-zoom","hammer","lrz"],i):t.PhotoClip=i(t.IScroll,t.Hammer,t.lrz)}(this,function(t,i,e){"use strict";function o(t,i){return this instanceof o?(this._$container=L(t),void(this._$container&&(this._options=u(!0,{},H,i),void 0===R&&this._options.errorMsg.noSupport&&alert(this._options.errorMsg.noSupport),this._init()))):new o(i)}function r(t,i,e,o){var r=t/e,n=i/o;return r>n?r:n}function n(t,i,e){i=(i||0).toFixed(2),e=(e||0).toFixed(2),z(t,R+"transform-origin",i+"px "+e+"px")}function a(t,i,e,o){i=i.toFixed(2),e=e.toFixed(2),o=o.toFixed(2),z(t,R+"transform","translateZ(0) translate("+i+"px,"+e+"px) rotate("+o+"deg)")}function s(t,i,e,o,r,n){z(t,R+"transform"),z(t,R+"transition",R+"transform "+r+"ms cubic-bezier(0.1, 0.57, 0.1, 1)"),a(t,i,e,o),setTimeout(function(){z(t,R+"transition",""),n()},r)}function h(t,i){var e=l(i),o=Math.sin(e),r=Math.cos(e);return{x:r*t.x-o*t.y,y:r*t.y+o*t.x}}function l(t){return t/180*Math.PI}function _(t,i,e,o){e=e||0,o=o||0;var r,n;return g([t,i],function(){r=t.getBoundingClientRect(),n=i.getBoundingClientRect()}),{x:n.left-r.left+e,y:n.top-r.top+o}}function c(t,i,e){i=i||0,e=e||0;var o;return g(t,function(){o=t.getBoundingClientRect()}),{x:i-o.left,y:e-o.top}}function u(){var t,i,e,o,r,n=arguments[0]||{},a=typeof n,s=Object.prototype.toString,h=1,l=arguments.length,_=!1;for("boolean"===a&&(_=n,n=arguments[h]||{},a=typeof n,h++),"object"!==a&&"function"!==a&&(n={}),h===l&&(n=this,h--);l>h;h++)if(null!=(t=arguments[h]))for(i in t)e=n[i],o=t[i],n!==o&&(_&&o&&(r="[object Array]"===s.call(o))||"[object Object]"===s.call(o)?(r?(r=!1,e=e&&"[object Array]"===s.call(e)?e:[]):e=e&&"[object Object]"===s.call(e)?e:{},n[i]=u(_,e,o)):void 0!==o&&(n[i]=o));return n}function p(t,i){if("string"==typeof i){var e=t[i];i=t,t=e}if("function"!=typeof t)return void 0;var o=Array.prototype.slice,r=o.call(arguments,2),n=function(){return t.apply(i||this,r.concat(o.call(arguments)))};return n.guid=t.guid=t.guid||C++,n}function g(t,i,e){"object"!=typeof t&&(t=[]),"undefined"==typeof t.length&&(t=[t]);for(var o,r=[],n=[],a=0;o=t[a++];)for(;o instanceof HTMLElement;){var s=o.nodeName;if(!o.getClientRects().length){r.push(o),n.push(o.style.display);var h=W[s];if(!h){var l=document.createElement(s);document.body.appendChild(l),h=window.getComputedStyle(l).display,l.parentNode.removeChild(l),"none"===h&&(h="block"),W[s]=h}o.style.display=h}if("BODY"===s)break;o=o.parentNode}"function"==typeof i&&i.call(e||this);for(var _=r.length;_--;)r.pop().style.display=n.pop()}function d(t){return/%$/.test(t+"")}function m(t){return"number"==typeof t}function f(t){return"[object Array]"===Object.prototype.toString.call(t)}function y(t,i,e,o){var r=document.createElement("DIV");if("object"==typeof i&&(o=i,i=null),"object"==typeof e&&(o=e,e=null),"object"==typeof o)for(var n in o)r.style[n]=o[n];return i&&(r.className=i),e&&(r.id=e),t.appendChild(r),r}function v(t){t.parentNode&&t.parentNode.removeChild(t)}function L(t,i){return t instanceof HTMLElement?t:t&&"string"==typeof t?("string"==typeof i&&(i=document.querySelector(i)),i instanceof HTMLElement||(i=document),i.querySelector(t)):null}function $(t,i,e){if("object"==typeof i){for(var o in i)t[o]=i[o];return t}return void 0===e?t[i]:(t[i]=e,t)}function z(t,i,e){if("object"==typeof i){for(var o in i)e=i[o],m(e)&&(e+="px"),t.style[o]=e;return t}return void 0===e?window.getComputedStyle(t)[i]:(m(e)&&(e+="px"),t.style[i]=e,t)}function b(t){var i=document.documentElement;if(t in i.style)return"";for(var e,o=t.charAt(0).toUpperCase()+t.substr(1),r=["Webkit","Moz","ms","O"],n=0;e=r[n++];)if(e+o in i.style)return"-"+e.toLowerCase()+"-"}var S=!!navigator.userAgent.match(/mobile/i),k=!!navigator.userAgent.match(/android/i),w=b("transition"),R=b("transform"),x=function(){},H={size:[100,100],adaptive:"",outputSize:[0,0],outputType:"jpg",outputQuality:.8,rotateFree:!k,view:"",file:"",ok:"",img:"",loadStart:x,loadComplete:x,loadError:x,done:x,fail:x,lrzOption:{width:k?1e3:void 0,height:k?1e3:void 0,quality:.7},style:{maskColor:"rgba(0,0,0,.5)",maskBorder:"2px dashed #ddd",jpgFillColor:"#fff"},errorMsg:{noSupport:"您的浏览器版本过于陈旧，无法支持裁图功能，请更换新的浏览器！",notFile:"您的浏览器不支持 HTML5 的 FileReader API，因此不能使用 file 控件读取图片！",imgError:"不支持该图片格式，请选择常规格式的图片文件！",imgHandleError:"图片处理失败！请更换其它图片尝试。",imgLoadError:"图片读取失败！请更换其它图片尝试。",noImg:"没有可裁剪的图片！",clipError:"截图失败！当前图片源文件可能存在跨域问题，请确保图片与应用同源。如果您是在本地环境下执行本程序，请更换至服务器环境。"}},M=o.prototype;M.constructor=o,M._init=function(){var t=this._options;m(t.size)?t.size=[t.size,t.size]:f(t.size)?((!m(t.size[0])||t.size[0]<=0)&&(t.size[0]=H.size[0]),(!m(t.size[1])||t.size[1]<=0)&&(t.size[1]=H.size[1])):t.size=u({},H.size),m(t.outputSize)?t.outputSize=[t.outputSize,0]:f(t.outputSize)?((!m(t.outputSize[0])||t.outputSize[0]<0)&&(t.outputSize[0]=H.outputSize[0]),(!m(t.outputSize[1])||t.outputSize[1]<0)&&(t.outputSize[1]=H.outputSize[1])):t.outputSize=u({},H.outputSize),t.outputType="jpg"===t.outputType?"image/jpeg":"image/png",f(t.adaptive)&&(this._widthIsPercent=t.adaptive[0]&&d(t.adaptive[0])?t.adaptive[0]:!1,this._heightIsPercent=t.adaptive[1]&&d(t.adaptive[1])?t.adaptive[1]:!1),this._outputWidth=t.outputSize[0],this._outputHeight=t.outputSize[1],this._canvas=document.createElement("canvas"),this._fileReader=null,this._iScroll=null,this._hammerManager=null,this._clipWidth=0,this._clipHeight=0,this._clipSizeRatio=1,this._$img=null,this._imgLoading=!1,this._imgLoaded=!1,this._containerWidth=0,this._containerHeight=0,this._$clipLayer=null,this._$moveLayer=null,this._$rotationLayer=null,this._$view=null,this._$file=null,this._$ok=null,this._$mask=null,this._$mask_left=null,this._$mask_right=null,this._$mask_right=null,this._$mask_bottom=null,this._$clip_frame=null,this._atRotation=!1,this._rotationLayerWidth=0,this._rotationLayerHeight=0,this._rotationLayerX=0,this._rotationLayerY=0,this._rotationLayerOriginX=0,this._rotationLayerOriginY=0,this._curAngle=0,this._initProxy(),this._initElements(),this._initScroll(),this._initRotationEvent(),this._initFile(),this._resize(),window.addEventListener("resize",this._resize),(this._$ok=L(t.ok))&&this._$ok.addEventListener("click",this._clipImg),this._options.img&&this._lrzHandle(this._options.img)},M._initElements=function(){var t=this._$container,i=t.style,e={};e["user-select"]=i["user-select"],e.overflow=i.overflow,e.position=i.position,this._containerOriginStyle=e,z(t,{"user-select":"none",overflow:"hidden"}),"static"===z(t,"position")&&z(t,"position","relative"),this._$clipLayer=y(t,"photo-clip-layer",{position:"absolute",left:"50%",top:"50%"}),this._$moveLayer=y(this._$clipLayer,"photo-clip-move-layer"),this._$rotationLayer=y(this._$moveLayer,"photo-clip-rotation-layer");var o=this._$mask=y(t,"photo-clip-mask",{position:"absolute",left:0,top:0,width:"100%",height:"100%","pointer-events":"none"}),r=this._options,n=r.style.maskColor,a=r.style.maskBorder;this._$mask_left=y(o,"photo-clip-mask-left",{position:"absolute",left:0,right:"50%",top:"50%",bottom:"50%",width:"auto","background-color":n}),this._$mask_right=y(o,"photo-clip-mask-right",{position:"absolute",left:"50%",right:0,top:"50%",bottom:"50%","background-color":n}),this._$mask_top=y(o,"photo-clip-mask-top",{position:"absolute",left:0,right:0,top:0,bottom:"50%","background-color":n}),this._$mask_bottom=y(o,"photo-clip-mask-bottom",{position:"absolute",left:0,right:0,top:"50%",bottom:0,"background-color":n}),this._$clip_frame=y(o,"photo-clip-area",{border:a,position:"absolute",left:"50%",top:"50%"});var s=this._$view=L(r.view);if(s){var i=s.style,h={};h["background-repeat"]=i["background-repeat"],h["background-position"]=i["background-position"],h["background-size"]=i["background-size"],this._viewOriginStyle=h,z(s,{"background-repeat":"no-repeat","background-position":"center","background-size":"contain"})}},M._initScroll=function(){this._iScroll=new t(this._$clipLayer,{zoom:!0,scrollX:!0,scrollY:!0,freeScroll:!0,mouseWheel:!0,wheelAction:"zoom",bounceTime:300})},M._refreshScroll=function(t){t=t||0;var i=this._iScroll.options,e=this._rotationLayerWidth,o=this._rotationLayerHeight;e&&o?(i.zoomMin=r(this._clipWidth,this._clipHeight,e,o),i.zoomMax=Math.max(1,i.zoomMin),i.startZoom=Math.min(i.zoomMax,r(this._containerWidth,this._containerHeight,e,o))):(i.zoomMin=1,i.zoomMax=1,i.startZoom=1),z(this._$moveLayer,{width:e,height:o}),this._$clipLayer.appendChild(this._$moveLayer),this._iScroll.refresh(t)},M._resetScroll=function(t,i){t=t||0,i=i||0,this._rotationLayerWidth=t,this._rotationLayerHeight=i,this._rotationLayerX=0,this._rotationLayerY=0,this._curAngle=0,a(this._$rotationLayer,this._rotationLayerX,this._rotationLayerY,this._curAngle),z(this._$rotationLayer,{width:t,height:i}),this._refreshScroll();var e=this._iScroll,o=e.scale,r=.5*(this._clipWidth-t*o),n=.5*(this._clipHeight-i*o);e.scrollTo(r,n),e.zoom(e.options.startZoom,void 0,void 0,0)},M._initRotationEvent=function(){if(S){this._hammerManager=new i.Manager(this._$moveLayer),this._hammerManager.add(new i.Rotate);var t,e,o,r=this,n=this._options.rotateFree,a=this._iScroll.options.bounceTime;this._hammerManager.on("rotatestart",function(i){r._atRotation||(t=!0,n?(e=(i.rotation-r._curAngle)%360,r._rotationLayerRotateReady(i.center)):e=i.rotation)}),this._hammerManager.on("rotatemove",function(i){t&&(o=i.rotation-e,n&&r._rotationLayerRotate(o))}),this._hammerManager.on("rotateend rotatecancel",function(i){if(t){if(t=!1,!n)return o%=360,o>180?o-=360:-180>o&&(o+=360),void(o>30?r._rotateBy(90,a,i.center):-30>o&&r._rotateBy(-90,a,i.center));var e=o%360;0>e&&(e+=360),10>e?o+=-e:e>80&&100>e?o+=90-e:e>170&&190>e?o+=180-e:e>260&&280>e?o+=270-e:e>350&&(o+=360-e),r._rotationLayerRotateFinish(o,a)}})}else this._$moveLayer.addEventListener("dblclick",this._rotateCW90)},M._rotateCW90=function(t){this._rotateBy(90,this._iScroll.options.bounceTime,{x:t.clientX,y:t.clientY})},M._rotateBy=function(t,i,e){this._rotateTo(this._curAngle+t,i,e)},M._rotateTo=function(t,i,e){this._atRotation||(this._rotationLayerRotateReady(e),this._rotationLayerRotateFinish(t,i))},M._rotationLayerRotateReady=function(t){var i,e=this._iScroll.scale;i=t?c(this._$rotationLayer,t.x,t.y):_(this._$rotationLayer,this._$clipLayer,.5*this._clipWidth,.5*this._clipHeight),i.x/=e,i.y/=e;var o={x:i.x-this._rotationLayerX,y:i.y-this._rotationLayerY},r=h(o,-this._curAngle);this._rotationLayerOriginX=r.x,this._rotationLayerOriginY=r.y;var s=this._$rotationLayer.getBoundingClientRect();n(this._$rotationLayer,this._rotationLayerOriginX,this._rotationLayerOriginY);var l=this._$rotationLayer.getBoundingClientRect();this._rotationLayerX+=(s.left-l.left)/e,this._rotationLayerY+=(s.top-l.top)/e,a(this._$rotationLayer,this._rotationLayerX,this._rotationLayerY,this._curAngle)},M._rotationLayerRotate=function(t){a(this._$rotationLayer,this._rotationLayerX,this._rotationLayerY,t),this._curAngle=t},M._rotationLayerRotateFinish=function(t,i){a(this._$rotationLayer,this._rotationLayerX,this._rotationLayerY,t);var e=this._$rotationLayer.getBoundingClientRect();n(this._$rotationLayer,0,0);var o=this._$rotationLayer.getBoundingClientRect();a(this._$rotationLayer,this._rotationLayerX,this._rotationLayerY,0);var r=this._$rotationLayer.getBoundingClientRect(),h=this._$moveLayer.getBoundingClientRect(),l={x:e.left-h.left,y:e.top-h.top},_=this._iScroll,c=_.scale;this._rotationLayerWidth=e.width/c,this._rotationLayerHeight=e.height/c,this._rotationLayerX=(r.left-o.left)/c,this._rotationLayerY=(r.top-o.top)/c,_.scrollTo(_.x+l.x,_.y+l.y),this._refreshScroll(_.options.bounceTime);var u=Math.max(_.options.zoomMin,Math.min(_.options.zoomMax,c));if(u!==c&&(l.x=l.x/c*u,l.y=l.y/c*u),_.startX+=l.x,_.startY+=l.y,t!==this._curAngle&&i&&m(i)&&void 0!==w){l={x:(o.left-e.left)/c,y:(o.top-e.top)/c},n(this._$rotationLayer,this._rotationLayerOriginX,this._rotationLayerOriginY),a(this._$rotationLayer,this._rotationLayerX+l.x,this._rotationLayerY+l.y,this._curAngle);var p=this;this._atRotation=!0,s(this._$rotationLayer,this._rotationLayerX+l.x,this._rotationLayerY+l.y,t,i,function(){p._atRotation=!1,p._rotateFinishUpdataElem(t)})}else this._rotateFinishUpdataElem(t)},M._rotateFinishUpdataElem=function(t){n(this._$rotationLayer,this._rotationLayerOriginX=0,this._rotationLayerOriginY=0),a(this._$rotationLayer,this._rotationLayerX,this._rotationLayerY,this._curAngle=t%360)},M._initFile=function(){var t=this._options,i=t.errorMsg;if(this._$file=L(t.file)){if(!window.FileReader)return void(i.notFile&&alert(i.notFile));S||$(this._$file,"accept","image/jpeg, image/x-png, image/gif"),this._fileReader=new FileReader,this._$file.addEventListener("change",this._fileOnChangeHandle)}},M._fileOnChangeHandle=function(t){var i=this,e=this._options,o=e.errorMsg,r=t.target.files;if(r.length){var n=r[0];return/image\/\w+/.test(n.type)?(this._imgLoading||(this._imgLoading=!0,e.loadStart.call(this,n)),this._fileReader.onprogress=function(t){console.log((t.loaded/t.total*100).toFixed()+"%")},this._fileReader.onload=function(){i._lrzHandle(n)},this._fileReader.onerror=function(t){e.loadError.call(i,o.imgLoadError,t),i._imgLoading=!1},this._fileReader.readAsDataURL(n),void 0):(e.loadError.call(this,o.imgError),!1)}},M._lrzHandle=function(t){var i=this,o=this._options,r=o.errorMsg;e(t,o.lrzOption).then(function(t){i._createImg(t.base64)}).catch(function(t){o.loadError.call(i,r.imgHandleError,t),i._imgLoading=!1})},M._clearImg=function(){this._$img&&(this._$img.onload=null,this._$img.onerror=null,v(this._$img),this._$img=null)},M._createImg=function(t){var i=this,e=this._options,o=e.errorMsg;this._clearImg(),this._$img=new Image,z(this._$img,{"user-select":"none","pointer-events":"none"}),this._imgLoading||(this._imgLoading=!0,e.loadStart.call(this,this._$img)),this._imgLoaded=!1,this._$img.onload=function(){i._imgLoaded=!0,i._imgLoading=!1,e.loadComplete.call(i,this),i._$rotationLayer.appendChild(this),g([this,i._$moveLayer],function(){i._resetScroll(this.naturalWidth,this.naturalHeight)},this)},this._$img.onerror=function(t){e.loadError.call(i,o.imgLoadError,t),i._imgLoading=!1},$(this._$img,"src",t)},M._clipImg=function(){var t=this._options,i=t.errorMsg;if(!this._imgLoaded)return void t.fail.call(this,i.noImg);var e=_(this._$rotationLayer,this._$clipLayer),o=this._iScroll.scale,r=1,n=1,a=this._canvas.getContext("2d");this._outputWidth||this._outputHeight?(this._canvas.width=this._outputWidth,this._canvas.height=this._outputHeight,r=this._outputWidth/this._clipWidth*o,n=this._outputHeight/this._clipHeight*o):(this._canvas.width=this._clipWidth/o,this._canvas.height=this._clipHeight/o),a.clearRect(0,0,this._canvas.width,this._canvas.height),a.fillStyle=t.style.jpgFillColor,a.fillRect(0,0,this._canvas.width,this._canvas.height),a.save(),a.scale(r,n),a.translate(this._rotationLayerX-e.x/o,this._rotationLayerY-e.y/o),a.rotate(this._curAngle*Math.PI/180),a.drawImage(this._$img,0,0),a.restore();try{var s=this._canvas.toDataURL(t.outputType,t.outputQuality);return this._$view&&z(this._$view,"background-image","url("+s+")"),t.done.call(this,s),s}catch(h){t.fail.call(this,i.clipError,h)}},M._resize=function(t,i){g(this._$container,function(){this._containerWidth=this._$container.offsetWidth,this._containerHeight=this._$container.offsetHeight},this);var e=this._options.size,o=this._clipWidth,r=this._clipHeight;if(m(t)&&(e[0]=t),m(i)&&(e[1]=i),this._widthIsPercent||this._heightIsPercent){var n=e[0]/e[1];this._widthIsPercent&&(this._clipWidth=this._containerWidth/100*parseFloat(this._widthIsPercent),this._heightIsPercent||(this._clipHeight=this._clipWidth/n)),this._heightIsPercent&&(this._clipHeight=this._containerHeight/100*parseFloat(this._heightIsPercent),this._widthIsPercent||(this._clipWidth=this._clipHeight*n))}else this._clipWidth=e[0],this._clipHeight=e[1];var a=this._clipWidth,s=this._clipHeight;if(this._clipSizeRatio=a/s,this._outputWidth&&!this._outputHeight&&(this._outputHeight=this._outputWidth/this._clipSizeRatio),this._outputHeight&&!this._outputWidth&&(this._outputWidth=this._outputHeight*this._clipSizeRatio),z(this._$clipLayer,{width:a,height:s,"margin-left":-a/2,"margin-top":-s/2}),z(this._$mask_left,{"margin-right":a/2,"margin-top":-s/2,"margin-bottom":-s/2}),z(this._$mask_right,{"margin-left":a/2,"margin-top":-s/2,"margin-bottom":-s/2}),z(this._$mask_top,{"margin-bottom":s/2}),z(this._$mask_bottom,{"margin-top":s/2}),z(this._$clip_frame,{width:a,height:s}),z(this._$clip_frame,R+"transform","translate(-50%, -50%)"),a!==o||s!==r){this._refreshScroll();var h=this._iScroll,l=h.scale,_=.5*(a-o)*l,c=.5*(s-r)*l;h.scrollBy(_,c);var u=Math.max(h.options.zoomMin,Math.min(h.options.zoomMax,l));u!==l&&h.zoom(u,void 0,void 0,0)}},M._initProxy=function(){this._fileOnChangeHandle=p(this,"_fileOnChangeHandle"),this._rotateCW90=p(this,"_rotateCW90"),this._resize=p(this,"_resize"),this._clipImg=p(this,"_clipImg"),this.size=p(this,"size"),this.load=p(this,"load"),this.rotateBy=p(this,"rotateBy"),this.rotateTo=p(this,"rotateTo"),this.clip=p(this,"clip"),this.destroy=p(this,"destroy")},M.size=function(t,i){return this._resize(t,i),this},M.load=function(t){return this._lrzHandle(t),this},M.clear=function(){return this._clearImg(),this._resetScroll(),this._$file.value="",this},M.rotateBy=function(t,i,e){return this._rotateBy(t,i,e),this},M.rotateTo=function(t,i,e){return this._rotateTo(t,i,e),this},M.clip=function(){return this._clipImg()},M.destroy=function(){window.removeEventListener("resize",this._resize),this._$container.removeChild(this._$clipLayer),this._$container.removeChild(this._$mask),z(this._$container,this._containerOriginStyle),this._$view&&z(this._$view,this._viewOriginStyle),this._fileReader&&(this._fileReader.onprogress=null,this._fileReader.onload=null,this._fileReader.onerror=null),this._iScroll&&this._iScroll.destroy(),this._hammerManager?(this._hammerManager.off("rotatemove"),this._hammerManager.off("rotateend"),this._hammerManager.destroy()):this._$moveLayer.removeEventListener("dblclick",this._rotateCW90),this._$img&&(this._$img.onload=null,this._$img.onerror=null),this._$file&&this._$file.removeEventListener("change",this._fileOnChangeHandle),this._$ok&&this._$ok.removeEventListener("click",this._clipImg);for(var t in this)delete this[t];this.__proto__=Object.prototype};var C=0,W={};return o});